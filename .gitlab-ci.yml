# =============================================================================
# NetBox GitOps Controller - CI/CD Pipeline
# =============================================================================
#
# CONFIGURATION INSTRUCTIONS:
# ---------------------------
# This pipeline uses variables for all environment-specific settings.
# To configure for your environment, set these variables in:
#   GitLab Project ‚Üí Settings ‚Üí CI/CD ‚Üí Variables
#
# Required variables to override (if using private infrastructure):
#
#   GITLAB_RUNNER_TAG          GitLab runner tag
#                              Default: "docker"
#
#   PYTHON_LEGACY_IMAGE        Python image for legacy support
#                              Default: "python:3.11"
#
# Optional variables to override:
#
#   GOLANG_IMAGE               Go compiler image
#                              Default: "golang:1.24"
#
#   PYTHON_IMAGE               Python image for utilities
#                              Default: "python:3.11-slim"
#
# PIPELINE SPEED CONTROLS:
# ------------------------
# Speed up your pipelines by skipping optional quality checks and tests.
# Set these per-pipeline run or as project variables:
#
#   RUN_QUALITY_CHECKS         Skip linting and YAML validation
#                              Set to "false" to skip (default: "true")
#                              Skips: go_lint, yaml_check
#
#   RUN_TESTS                  Skip test execution
#                              Set to "false" to skip (default: "true")
#                              Skips: go_test, python_test
#
# HOW TO USE:
# 1. Per-pipeline: GitLab ‚Üí CI/CD ‚Üí Run Pipeline ‚Üí Add variable
# 2. Project-wide: GitLab ‚Üí Settings ‚Üí CI/CD ‚Üí Variables
# 3. Example: Set RUN_QUALITY_CHECKS=false for faster development iterations
#
# =============================================================================

stages:
  - test      # Run tests
  - build     # Build Go binary
  - validate  # Validate YAML and configuration
  - plan      # Dry-run preview (Merge Requests)
  - apply     # Apply changes (Main branch)

variables:
  # ===========================================================================
  # ENVIRONMENT-SPECIFIC VARIABLES
  # Override these in GitLab CI/CD Settings > Variables for your environment
  # ===========================================================================

  # GitLab Runner tag (override in GitLab Variables if needed)
  GITLAB_RUNNER_TAG: "docker"

  # Container image registry paths (override in GitLab Variables for private registries)
  GOLANG_IMAGE: "golang:1.24"
  PYTHON_IMAGE: "python:3.11-slim"
  PYTHON_LEGACY_IMAGE: "python:3.11"  # Override with your custom image if needed

  # ===========================================================================
  # PIPELINE CONTROL VARIABLES
  # Set these per-pipeline to skip optional jobs and speed up execution
  # ===========================================================================

  # RUN_QUALITY_CHECKS: Controls linting and YAML validation jobs
  # Set to "false" to skip quality checks (faster pipeline)
  # Default: "true" - runs all quality checks
  RUN_QUALITY_CHECKS: "true"

  # RUN_TESTS: Controls test execution (go_test, python_test)
  # Set to "false" to skip tests (faster pipeline)
  # Default: "true" - runs all tests
  RUN_TESTS: "true"

  # ===========================================================================
  # BUILD CONFIGURATION
  # ===========================================================================

  # Python variables
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR"

  # Go variables
  GOPATH: "$CI_PROJECT_DIR/.go"
  GOCACHE: "$CI_PROJECT_DIR/.cache/go-build"
  CGO_ENABLED: "1"

default:
  tags:
    - ${GITLAB_RUNNER_TAG}

cache:
  paths:
    - .cache/pip
    - .cache/go-build
    - .go/pkg/mod

# =============================================================================
# GO JOBS (Primary Implementation)
# =============================================================================

.go_base:
  image: ${GOLANG_IMAGE}
  before_script:
    - go version
    - go mod download

# Run Go tests
go_test:
  extends: .go_base
  stage: test
  script:
    - echo "üß™ Running Go tests..."
    - go test ./pkg/... -v -cover -race
    - echo "‚úÖ All Go tests passed!"
  rules:
    - if: $RUN_TESTS == "false"
      when: never
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH

# Build Go binary
go_build:
  extends: .go_base
  stage: build
  script:
    - echo "üî® Building Go binary..."
    - go build -v -o netbox-gitops ./cmd/netbox-gitops/
    - ./netbox-gitops --help
    - echo "‚úÖ Go binary built successfully!"
  artifacts:
    paths:
      - netbox-gitops
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH

# Validate with Go (dry-run)
go_validate:
  extends: .go_base
  stage: validate
  dependencies:
    - go_build
  script:
    - echo "üîç Validating with Go implementation..."
    - ./netbox-gitops --data-dir=example --dry-run
    - echo "‚úÖ Validation passed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH

# Plan changes with Go (MR preview)
go_plan:
  extends: .go_base
  stage: plan
  dependencies:
    - go_build
  script:
    - echo "üìú Generating sync plan with Go..."
    - ./netbox-gitops --data-dir=example --dry-run | tee plan-output.txt
    - echo "‚úÖ Plan generated successfully!"
  artifacts:
    paths:
      - plan-output.txt
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

# Apply changes with Go (production)
go_apply:
  extends: .go_base
  stage: apply
  dependencies:
    - go_build
  script:
    - echo "üöÄ Applying changes to NetBox with Go..."
    - ./netbox-gitops
    - echo "‚úÖ Changes applied successfully!"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  environment:
    name: production

# =============================================================================
# PYTHON JOBS (Legacy Support)
# =============================================================================

.python_base:
  image: ${PYTHON_LEGACY_IMAGE}
  before_script:
    - echo "üîß Setting up Python environment..."
    - pip install -r requirements.txt

python_test:
  extends: .python_base
  stage: test
  script:
    - echo "üß™ Running Python tests..."
    - python -m pytest tests/ || echo "No Python tests found"
  allow_failure: true
  rules:
    - if: $RUN_TESTS == "false"
      when: never
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
    - if: $CI_COMMIT_BRANCH
      when: manual

python_validate:
  extends: .python_base
  stage: validate
  script:
    - echo "Validating with Python implementation (legacy)..."
    - echo "Note - Python implementation does not support --data-dir flag"
    - python src/main.py --dry-run
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: manual

python_apply:
  extends: .python_base
  stage: apply
  script:
    - echo "üöÄ Applying changes with Python (legacy)..."
    - python src/main.py
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  environment:
    name: production-python
  allow_failure: true

# =============================================================================
# UTILITY JOBS
# =============================================================================

go_lint:
  extends: .go_base
  stage: test
  script:
    - echo "üîç Running Go linters..."
    - go fmt ./...
    - go vet ./...
    - echo "‚úÖ Linting passed!"
  allow_failure: true
  rules:
    - if: $RUN_QUALITY_CHECKS == "false"
      when: never
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH

yaml_check:
  image: ${PYTHON_IMAGE}
  stage: test
  before_script:
    - pip install pyyaml
  script:
    - echo "üìù Checking YAML syntax..."
    # Check YAML files in example directory (used by CI) and any custom definitions
    - |
      python -c "
      import yaml, glob, sys
      files = glob.glob('example/definitions/**/*.yaml', recursive=True) + glob.glob('example/inventory/**/*.yaml', recursive=True)
      files += glob.glob('definitions/**/*.yaml', recursive=True) + glob.glob('inventory/**/*.yaml', recursive=True)
      if not files:
          print('‚ö†Ô∏è  No YAML files found to check.')
          sys.exit(0)
      print(f'Found {len(files)} YAML files to validate')
      for f in files:
          print(f'Checking {f}...')
          with open(f, 'r') as stream:
              yaml.safe_load(stream)
      print('‚úÖ All found YAML files are valid!')
      "
  rules:
    - if: $RUN_QUALITY_CHECKS == "false"
      when: never
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH

debug_environment:
  extends: .go_base
  stage: build
  script:
    - echo "üìÇ Repository structure:"
    - ls -la
    - echo "üìÇ Example directory structure:"
    - ls -la example/ || echo "No example directory"
    - echo "üì¶ Go modules:"
    - go list -m all
    - echo "üîß Go environment:"
    - go env
    - echo "üêç Python version (if available):"
    - python --version || echo "Python not available"
    - echo "üìÑ Binary info:"
    - ./netbox-gitops --help || echo "Binary not built yet"
    - echo "üß™ Testing --data-dir flag:"
    - ./netbox-gitops --data-dir=example --help || echo "Data dir flag test failed"
  dependencies:
    - go_build
  when: manual
  allow_failure: true
