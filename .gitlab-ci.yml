stages:
  - test      # Run tests
  - build     # Build Go binary
  - validate  # Validate YAML and configuration
  - plan      # Dry-run preview (Merge Requests)
  - apply     # Apply changes (Main branch)

variables:
  # Python variables
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR"

  # Go variables
  GOPATH: "$CI_PROJECT_DIR/.go"
  GOCACHE: "$CI_PROJECT_DIR/.cache/go-build"
  CGO_ENABLED: "0"

cache:
  paths:
    - .cache/pip
    - .cache/go-build
    - .go/pkg/mod

# =============================================================================
# GO JOBS (Primary Implementation)
# =============================================================================

.go_base:
  image: golang:1.21
  before_script:
    - go version
    - go mod download

# Run Go tests
go_test:
  extends: .go_base
  stage: test
  script:
    - echo "üß™ Running Go tests..."
    - go test ./pkg/... -v -cover -race
    - echo "‚úÖ All Go tests passed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH

# Build Go binary
go_build:
  extends: .go_base
  stage: build
  script:
    - echo "üî® Building Go binary..."
    - go build -v -o netbox-gitops ./cmd/netbox-gitops/
    - ./netbox-gitops --help
    - echo "‚úÖ Go binary built successfully!"
  artifacts:
    paths:
      - netbox-gitops
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH

# Validate with Go (dry-run)
go_validate:
  extends: .go_base
  stage: validate
  dependencies:
    - go_build
  script:
    - echo "üîç Validating with Go implementation..."
    - ./netbox-gitops --dry-run
    - echo "‚úÖ Validation passed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH

# Plan changes with Go (MR preview)
go_plan:
  extends: .go_base
  stage: plan
  dependencies:
    - go_build
  script:
    - echo "üìú Generating sync plan with Go..."
    - ./netbox-gitops --dry-run | tee plan-output.txt
    - echo "‚úÖ Plan generated successfully!"
  artifacts:
    paths:
      - plan-output.txt
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

# Apply changes with Go (production)
go_apply:
  extends: .go_base
  stage: apply
  dependencies:
    - go_build
  script:
    - echo "üöÄ Applying changes to NetBox with Go..."
    - ./netbox-gitops
    - echo "‚úÖ Changes applied successfully!"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  environment:
    name: production

# =============================================================================
# PYTHON JOBS (Legacy Support)
# =============================================================================

.python_base:
  image: nexus.denbi.bihealth.org:8089/admin/pynetbox:v1.0
  before_script:
    - echo "üîß Setting up Python environment..."
    - pip install -r requirements.txt

# Python tests (if any exist)
python_test:
  extends: .python_base
  stage: test
  script:
    - echo "üß™ Running Python tests..."
    - python -m pytest tests/ || echo "No Python tests found"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH
  when: manual

# Python validate (legacy)
python_validate:
  extends: .python_base
  stage: validate
  script:
    - echo "üîç Validating with Python implementation (legacy)..."
    - python src/main.py --dry-run
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
  when: manual

# Python apply (legacy fallback)
python_apply:
  extends: .python_base
  stage: apply
  script:
    - echo "üöÄ Applying changes with Python (legacy)..."
    - python src/main.py
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  environment:
    name: production-python
  allow_failure: true

# =============================================================================
# UTILITY JOBS
# =============================================================================

# Lint Go code
go_lint:
  extends: .go_base
  stage: test
  script:
    - echo "üîç Running Go linters..."
    - go fmt ./...
    - go vet ./...
    - echo "‚úÖ Linting passed!"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH

# Check YAML syntax
yaml_check:
  image: python:3.11-slim
  stage: test
  before_script:
    - pip install pyyaml
  script:
    - echo "üìù Checking YAML syntax..."
    - python -c "import yaml; import sys; [yaml.safe_load(open(f)) for f in sys.argv[1:]]" definitions/**/*.yaml inventory/**/*.yaml
    - echo "‚úÖ YAML syntax is valid!"
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH

# Debug environment (manual)
debug_environment:
  extends: .go_base
  stage: test
  script:
    - echo "üìÇ Repository structure:"
    - ls -la
    - echo "üì¶ Go modules:"
    - go list -m all
    - echo "üîß Go environment:"
    - go env
    - echo "üêç Python version (if available):"
    - python --version || echo "Python not available"
    - echo "üìÑ Binary info:"
    - ./netbox-gitops --help || echo "Binary not built yet"
  dependencies:
    - go_build
  when: manual
  allow_failure: true
